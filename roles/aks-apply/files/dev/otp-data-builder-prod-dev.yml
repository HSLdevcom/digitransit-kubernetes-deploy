---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: otp-databuilder-prod-volume
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: managed-premium
  resources:
    requests:
      storage: 2Gi
---
apiVersion: v1
kind: Service
metadata:
  name: otp-data-builder-prod
spec:
  ports:
  - port: 8080
    protocol: TCP
    name: otp-data-builder-prod-service-port
  selector:
    app: otp-data-builder-prod
---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: otp-data-builder-prod
  labels:
    app: otp-data-builder-prod
    update: auto
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: otp-data-builder-prod
  template:
    metadata:
      labels:
        app: otp-data-builder-prod
    spec:
      priorityClassName: high-priority
      containers:
      - name: otp-data-builder-prod
        image: hsldevcom/otp-data-builder:prod
        volumeMounts:
          - mountPath: var/run/docker.sock
            name: "docker-sock-volume"    
          - mountPath: opt/otp-data-builder/data    
            name: otp-data
        imagePullPolicy: Always
        securityContext:
          allowPrivilegeEscalation: false
        env:
        - name: BUILDER_TYPE
          value: "prod"
        - name: BUILD_TIME
          value: "00:00:00"
        - name: DOCKER_API_VERSION
          value: "1.38"
        - name: DATA
          value: "/opt/otp-data-builder/data"
        - name: DOCKER_AUTH
          valueFrom:
            secretKeyRef:
              name: docker-auth
              key: docker-auth
        - name: DOCKER_TAG
          value: "prod"
        - name: DOCKER_USER
          valueFrom:
            secretKeyRef:
              name: docker-user
              key: docker-user
        - name: HOST_DATA
          value: "/opt/otp-data"
        - name: OTP_TAG
          value: "prod"
        - name: ROUTERS
          value: "finland, waltti, hsl"
        - name: SEED_TAG
          value: "prod"
        - name: SLACK_WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: slack-webhook
              key: slack-webhook
        - name: TOOLS_TAG
          value: "prod"
        resources:
          requests:
            memory: 12Gi
            cpu: 3000m
          limits:
            memory: 12Gi
            cpu: 6000m
      volumes:
        - name: "docker-sock-volume"
          hostPath:
             # location on host
            path: /var/run/docker.sock
        - name: otp-data    
          hostPath:
            path: /opt/otp-data/

