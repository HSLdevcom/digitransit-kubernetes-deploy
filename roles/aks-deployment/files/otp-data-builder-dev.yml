apiVersion: v1
kind: Service
metadata:
  name: otp-data-builder
spec:
  ports:
  - port: 10027
    targetPort: 10027
    protocol: TCP
    name: otp-data-builder-service-port
  selector:
    app: otp-data-builder
---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: otp-data-builder
  labels:
    app: otp-data-builder
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: otp-data-builder
  template:
    metadata:
      labels:
        app: otp-data-builder
    spec:
      containers:
      - name: otp-data-builder
        image: hsldevcom/hsldevcom/otp-data-builder
        volumeMounts:
          - mountPath: /var/run/docker.sock
            name: "docker-sock"
          - mountPath: /opt/otp-data-builder/data"
            name: "otp-data"
          - mountPath: persistent # TODO: need to get path for persistent volume as secret
            name: "persistent"
        imagePullPolicy: Always
        securityContext:
          allowPrivilegeEscalation: false
        # TODO: network: BRIDGE ??
        ports:
        - containerPort: 10027
        livenessProbe:
          initialDelaySeconds: 30
          periodSeconds: 20
          failureThreshold: 2
          httpGet:
            port: 10027
            path: /
        env:
        - name: BUILDER_TYPE
          value: "dev"
        - name: BUILD_TIME
          value: "23:00:00"
        - name: DATA
          value: "/opt/otp-data-builder/data"
        - name: DOCKER_AUTH
          value: "dockerauth"
        - name: DOCKER_TAG
          value: "latest"
        - name: DOCKER_USER
          value: "dockeruser"
        - name: EXTRA_SRC
          value: "{\"MatkahuoltoKainuu\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/kainuu-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoSavo\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/savo-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoKanta\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/kanta-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoKarjala\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/karjala-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoKeski\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/keski-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoKyme\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/kyme-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoLappi\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/lappi-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoPohjanmaa\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/pohjanmaa-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoSatakunta\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/satakunta-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoVakka\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/vakka-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoVantaa\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/vantaa-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}, \"MatkahuoltoVarsinais\": {\"url\": \"http://digitransit-proxy:8080/out/minfoapi.matkahuolto.fi/gtfs/varsinais-fi/gtfs.zip\", \"fit\": false, \"routers\": [\"finland\"]}}"
        - name: EXTRA_UPDATERS 
          value: "{\"foli-alerts\": {\"url\": \"https://foli-beta.nanona.fi/gtfs-rt/reittiopas\", \"routers\": [\"waltti\"]}, \"hsl-trip-updates\": {\"topic\": \"gtfsrt/dev/fi/hsl/tu\", \"routers\": [\"hsl\", \"finland\"]}, \"hsl-alerts\": {\"url\": \"https://dev-api.digitransit.fi/realtime/service-alerts/v2/hsl\", \"routers\": [\"hsl\", \"finland\"]}}"
        - name: HOST_DATA
          value: "/var/lib/docker/otp/data"
        - name: OTP_TAG
          value: "latest"
        - name: ROUTERS
          value: "finland, waltti, hsl"
        - name: SEED_TAG
          value: "latest"
        - name: SLACK_WEBHOOK_URL
          value: "slackwebhook"
        - name: TOOLS_TAG
          value: "latest"
        resources:
          requests:
            memory: 12Gi
          limits:
            memory: 12Gi
            cpu: 3000m
      volumes:
        - name: "docker-sock"
          azureFile: # TODO: do we want volumes on same fileshare?
            secretName: dev-aks-fileshare
            shareName: devaksshare
            readOnly: false    
        - name: "otp-data" 
          hostPath:
            path: /var/lib/docker/otp/data
          azureFile: # TODO: do we want volumes on same fileshare?
            secretName: dev-aks-fileshare
            shareName: devaksshare
            readOnly: false 
        - name: "persistent"
          persistentVolumeClaim:
            claimName: persistentClaim # TODO: Persistent

